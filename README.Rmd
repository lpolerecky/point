---
output: 
  github_document:
    pandoc_args: --webtex
---
<!--  use the --webtex argument in the YAML to render equations -->


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  warning = FALSE, 
  results = "asis",
  encoding ='UTF-8'
)
```

# point

<!-- badges: start -->
<!-- badges: end -->

This projects was originally inspired by the lack of detailed insight in the inner workings of the default software for the Cameca NanoSIMS50L (Utrecht
University). Hence this project has the objective of processing raw count data into ion and isotope ratios of point-sourced measurements, and to establish the
internal and external precision of individual measurements and complete series of measurements, respectively

## Installation

You can install the released version of point 

<!-- ``` r -->
<!-- install.packages("point") -->
<!-- ``` -->

## Example

This is an example of how Cameca NanoSIMS50L raw datafiles can be extracted, processed and analysed for the $^{13}$C/$^{12}$C isotope ratio (R). This produces a tibble with descriptive and predictive poisson statistics (demarcated with $\hat$) of the ion count data.

```{r example}

# library(point)
devtools::load_all(".")
# Use system.file() to access the examples bundled with this package in the
# inst/extdata directory. The examples directories are named:
# 2020-01-17-TREASURE and "2018-01-19-GLENDON"

# raw data containing 13C and 12C counts on carbonate
tb.rw <- read_IC(system.file("extdata", "2018-01-19-GLENDON", package = "point"))

# processing raw ion count data
tb.pr <- cor_IC(tb.rw, N.rw, t.rw, det_type.mt, deadtime = 44, disc.value = NULL)

# single ion descriptive an predictive statistics for all measured ions
tb.Xt <- stat_Xt(tb.pr, Xt.pr, N.pr, file.nm, species.nm)

# descriptive an predictive statistics for 13C/12C ratios
tb.R <- stat_R(tb.pr, Xt.pr, N.pr, ID = "ID", ion1 = "13C", ion2 = "12C",
               file.nm, species.nm, latex = TRUE)


# use the second element of the list to get nice variable names rendering in 
# Rmarkdown
knitr::kable(tb.R[[1]] , escape = FALSE, 
             col.names = c("file","R", names(tb.R[[2]])),
             format.args = list(digits = 5, format = "G", flag = "0")) 
```


# Internal precision of the SIMS analysis

To check for internal consistency in the analytical output of the *NanoSIMS Cameca 50L*,  descriptive statistics and statistical inferences are compared with the results of predictive statistics of the raw counts ($N_{(i)}$) for single ions and isotopic ratios. 

## Descriptive statistics
As a first step, the counts of a single count cycle ($N_i$) are normalised against the time it took to complete the cycle ($0.541$ s) to account for differences in the count times for two different isotopes during stable isotopic SIMS analysis. Hence, for the time period ($t$) over which an isotope species $a$ during measurement $i$ accumulated, the count rate is given by 


$$X_i^{a} = N_i^{a} / t_i^{a}$$ {#eq:N.rate}

The sample mean ($\bar{x}$) of isotope species $a$ over a complete count block is given by: 

$$ \bar{x}_a =  \frac{1}{n} \sum_{i=1}^{n} X_i^a $$ {#eq:M.rate}

To validate the internal consistency of the SIMS data, it is necessary to define the internal precision of the count blocks. This can be done with the standard deviation ($s_x$), which gives the spread of the sample, and the standard error of the mean ($s_{\bar{x}}$), which defines how well this sample mean approximates the true population mean ($\mu$). These statistics rely on the assumption that the underlying probability distribution follows a normal distribution.    

### Standard deviation

The standard deviation for a limited sample of the population gives a measure of how individual measurements are spread about the mean in one count block, and is given by   



$$ s_x = \sqrt{\sum_{i=1}^{n}  \frac{(x_{i}-\bar{x})^2}{n-1}} $$ {#eq:std}
  

where $n$ is the number of measurement cycles in the count block and $x_i$ is the $i$-th measurement cycle. The number of measurements is subtracted with one ($n - 1$) to show that only $n - 1$ of the $(x_{i}-\bar{x})^2$ are independent. The sample standard can inform about the confidence whether a single measurements falls within a given range of the sample mean value. One can also report the standard deviation as a number relative to the sample mean by applying the following transformation

$$ e_x = \frac{s_x}{\bar{x}} $$ {#eq:rel.std}

### Standard error of the mean

The standard error of the mean ($s_{\bar{x}}$) provides a measure of how well the mean of a limited sample (i.e., count block) approximates the actual population mean. This measure can be used to gauge the precision of the count block with $n$ measurement cycles. This value is dependent on the number of measurements ($n$) and thus becomes smaller with increasing measurement numbers (i.e. $\bar{x}$ becomes more precise). The standard error of the mean is given by the following equation

$$ s_{\bar{x}} = \frac{s_{x}}{\sqrt{n}} $$ {#eq:se}

This equation as well can be recast to obtain the relative standard error of the mean ($e_{\bar{x}}$), where 

$$ e_{\bar{x}} = \frac{s_{\bar{x}}}{\bar{x}} $$ {#eq:rel.se}


### Error propagation for descriptive statistics of isotope ratios

The $\bar{x}_{R}$ can be calculated from the mean values of the specific ions of the complete count block.

$$ \bar{x}_{R} = \frac{\frac{1}{n}\sum_{i = 1}^{n} X_i^{b}}{\frac{1}{n}\sum_{i = 1}^{n} X_i^{a}} $$ {#eq:mean.R}

and this value can be considered as an estimate of the true isotopic value ($\mu_R$). The uncertainties associated with the SIMS count rates of the individual variables $X^{b}$ (e.g. ^13^C) and $X^{a}$ (e.g. ^12^C) need to be combined. This can be achieved by applying; *The formula for exact propagation of error*


$$s_x^{2} \approx \sum_{i = 1}^{n} \left[ \left( \frac{\partial F}{\partial z_i} \right) s_i^{2} \right] + 2 \sum_{j = 1}^{n} \sum_{k = 1}^{n} \left[ \left( \frac{\partial F}{\partial z_j} \right) \left( \frac{\partial F}{\partial z_k} \right) s_j s_k \right]$${#eq:er.prop}


, which ensures proper propagation of the error. In this formulation $r_{jk}$ stands for the correlation coefficient for the variables $z_j$ and $z_k$, as defined by

$$ r_{jk} = \frac{1}{\left(n-1\right) s_j s_k} \sum_{i=1}^n{ \left[ \left(z_{j}\right)_i - \bar{z}_j \right] \left[ \left(z_{k}\right)_i - \bar{z}_k \right]} $${#eq:corr}

yields an estimate for the sample correlation coefficient, where values can range between $-1$ and $+1$, and thereby recording a inverse or positive linear correlation between the variables, and no correlation if $r$ falls close to zero. For this the `R base` function `cor()` was used, with the `method` argument set to `"pearson"`.

Recasting [@eq:er.prop] for when $\mathrm{F}(...)$ is $R$, and with the variables $\bar{x}^{b}$ (e.g. ^13^C) and $\bar{x}^{a}$ (e.g. ^12^C), yields the following equation:
 
$$  s_{x_{R}} = \sqrt{ \left( \frac{ s_{x_{b}}}{\bar{x}_{b}} \right)^2 + \left( \frac{ s_{x_{a}}}{\bar{x}_{a}} \right)^2 - \frac{2r_{X^{b}X^{a}} s_{x_{b}} s_{x_{a}}}{\bar{x}_{b}\bar{x}_{a}}} \times \bar{x}_{R} $${#eq:er.prop.ad}

The standard error of the mean isotope value $s_{\bar{x}_{R}}$ is obtained through diving $s_{x_{R}}$ by $\sqrt(n)$. Both the standard deviation and standard error of the mean of the isotope value can be expressed as relative values in ‰ by dividing them through the $\bar{x}_{R}$ and multiplying by $1.000$.  
 
## Predictive statistics (Poisson)

SIMS measurements have an inherent fundamental imprecision, which  is dictated by the random nature of secondary ion production. This restrict the precision of the analysis to a certain analytical threshold. The amplitude of this inherent variation can be gauged with Poisson statistics. The Poisson distribution describes the likelihood of random events occurring over a defined (and fixed) time-period. Further conditions to be satisfied to validate the assumption of a Poisson distribution is the observation that $N$ should be able to occur over a larger number of occasions and that the probability of the event occurring at a particular occasions is limited but constant. In the case of SIMS measurements $N_i$ is the number of secondary ions counted by the detector during a single measurement cycle. 

### Predicted standard deviation

The predicted standard deviation of a whole count block is directly related to the population mean of $N_{(i)}$ ($\mu_{N}$) by the equation;

$$ \sigma = \sqrt(\mu_{N})$$ {#eq:base.pois}

In this formulation the population mean of N ($\mu_{N}$) can be substituted by the mean number of events (i.e. secondary ion counts) per time unit, or $\bar{N}$. The predicted standard deviation can therefore be deduced from the mean number of counts for that particular ion per count block, as follows

$$\hat{s}_{N} = \sqrt{\bar{N}}$$ {#eq:std.pois}

where:

$$\bar{N} = \frac{1}{n}\sum_{i=1}^{n}N_i$$ {#eq:mean.N}

In this formulation, the hat on $\hat{s}_x$ denotes that the statistics is predictive, instead of $s_x$ which is an observed value. The commonality of the two measures is, however that they are a estimate of the true population $\sigma$. 

### Predicted standard error of the mean

In a similar fashion the standard error of the mean for Poisson statistics depends again on the number of measurements $n$, and can be formulated as follows

$$\hat{s}_{\bar{N}} = \sqrt{\left( \frac{ \bar{N}}{n}\right)}$$ {#eq:se.pois}

### Error propagation for predictive statistics of isotope ratios

For SIMS isotope analysis we need to have at least two different count blocks, so that we can get a count ratio, as defined by [@eq:mean.R], and where $X_i$ is a time normalised count, or count rate. Satisfying this assumption provides us with count-rate ratio $R$ for measurement $i$ of the isotopes $a$ and $b$, where we take a mean $\bar{x}_{R}$ from the completed count block as our estimate of the true isotope value $\mu_R$.  As the predicted $\hat{S}_x$ can be calculated for single  ions, this should also mean that the uncertainty in the isotope measurement can be predicted ($\hat{S}_R$). And, again this requires proper error propagation to incorporate the cumulative errors on the counts of both isotopes; $N^{a}$ and $N^{b}$, over one count block [@Fitzsimons2000a]. Since the count-rate ratio $R$ is a linear function of the count ratio, it is possible to use the standard deviation of the count ratio $\hat{S}_{N^{b}/N^{a}}$ instead of $\hat{S}_{R}$, following that:

$$ \hat{S}_{R} \approx \left(\frac{t^{a}}{t^{b}} \right) \hat{S}_{N^{b}/N^{a}}$$ {#eq:N_R}

This provides the possibility to express $\hat{S}_{N^{b}/N^{a}}$ in terms of the standard deviations of the individual counts, and by using [@eq:er.prop], yielding;

$$ \hat{S}_{N^{b}/N^{a}} \approx \sqrt{ \left( \frac{\hat{S}_{N^{b}}}{N^{a}} \right) + \left( \frac{\hat{S}_{N^{b}}}{N^{a}} \right)  - \frac{2r_{N^{b}N^{a}} s_{N^{b}} s_{N^{a}}}{N^{b}N^{a}} }\times \frac{N^{b}}{N^{a}} $$ {#eq:std.pois.R1}

As the both count statistics are independent, the $r$ becomes zero. The predicted standard deviations for $N^{b}$ and $N^{a}$ can be approximated by the population mean, according to [@eq:std.pois], thereby transforming [@eq:std.pois.R1] to

$$ \hat{S}_{N^{b}/N^{a}} \approx \sqrt{\frac{1}{ \bar{N}^{b}} + \frac{1}{ \bar{N}^{a}}} \times  \bar{N}^{b}/\bar{N}^{a} $$ {#eq:std.pois.R2}

in which we can substitute [@eq:N_R] to obtain

$$ \hat{S}_{x} \approx \sqrt{\frac{1}{ \bar{N}^{b}} + \frac{1}{ \bar{N}^{a}}} \times  \frac{\bar{N}^{b}}{\bar{N}^{a}} \left( \frac{t^{a}}{t^{b}} \right) $$  {#eq:std.pois.R3}

, which is equivalent to 

$$ \hat{S}_{N^{b}/N^{a}} \approx \sqrt{\frac{1}{ \bar{N}^{b}} + \frac{1}{ \bar{N}^{a}}} \times  \bar{x}_{R}$$ {#eq:std.pois.R4}

In [@eq:std.pois.R4], we can substitute [@eq:mean.N] for $\bar{N}^{b}$ and $\bar{N}^{b}$, respectively.

$$ \hat{s}_{x_{R}} = 
        \sqrt{ 
            \left( 
                \frac{1}{\sum_{i = 1}^{n}{N_i^a}} \right)  + 
             \left( 
                 \frac{1}{\sum_{i = 1}^{n}{N_i^b}} \right)} \times \bar{x}_R \sqrt{n}
                $$ {#eq:std.pois.R5}

The predicted standard error of the mean of a repeated set of measurements in one count block is then:


$$ \hat{s}_{\bar{x}_{R}} = 
        \sqrt{ 
            \left( 
                \frac{1}{\sum_{i = 1}^{n}{N_i^a}} \right)  + 
             \left( 
                 \frac{1}{\sum_{i = 1}^{n}{N_i^b}} \right)}  \times  \bar{x}_R$$ {#eq:std.pois.R6}
                 
The latter to measures can be expressed as relative uncertainties in ‰, following the same transformation as for the descriptive statistics.         


## Verdict predictive and descriptive statistics

The $\chi^2$ is used how well the machine approximated the theoretical precision for isotope analysis:

$$\chi^2 = \left( \frac{s_{\bar{x}_R}} {\hat{s}_{\bar{x}_R}} \right)^2   $$
